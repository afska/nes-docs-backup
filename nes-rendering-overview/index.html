<!DOCTYPE html>
<!-- saved from url=(0054)https://austinmorlan.com/posts/nes_rendering_overview/ -->
<html lang="en-us"><input type="hidden" id="__yoroi_connector_api_injected_type" value="prod"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="author" content="Austin Morlan"><meta property="og:title" content="An Overview of NES Rendering"><meta property="og:description" content="I’m in the midst of creating an NES emulator and struggled at first to understand how the rendering worked at a high level. Nametable, attribute table, pattern table, background, sprites, palettes. The Nesdev Wiki has all of the info necessary but it isn’t presented in a way that clicked with me. The details were abundant but the big picture view was missing.
Cross-referencing the wiki and Nintendulator’s debug views, I put together a mental model of what’s going on."><meta property="og:type" content="article"><meta property="og:url" content="https://austinmorlan.com/posts/nes_rendering_overview/"><meta property="og:image" content="https://austinmorlan.com/posts/nes_rendering_overview/media/sprite_04.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-09-30T00:00:00+00:00"><meta property="article:modified_time" content="2019-09-30T00:00:00+00:00"><!--<base href="https://austinmorlan.com">--><base href="."><title>An Overview of NES Rendering - Austin Morlan</title><link rel="stylesheet" href="./An Overview of NES Rendering - Austin Morlan_files/style.css"><link rel="stylesheet" href="./An Overview of NES Rendering - Austin Morlan_files/syntax.css"><link rel="icon" type="image/png" href="https://austinmorlan.com/images/favicon-32x32.png" sizes="32x32"><link rel="icon" type="image/png" href="https://austinmorlan.com/images/favicon-16x16.png" sizes="16x16"><meta name="generator" content="Hugo 0.98.0"></head><body><main class="wrapper"><center><div style="font-size:1.2rem;margin-top:1rem;margin-bottom:2rem;display:inline-block;vertical-align:middle"><a href="https://austinmorlan.com/" style="text-decoration:none"><b>AUSTIN MORLAN</b></a><br><hr style="border:1px solid #fff"><div style="text-align:justify;display:inline-block;width:100%"><a href="https://code.austinmorlan.com/" style="text-decoration:none">CODE</a>
<a href="mailto:mail@austinmorlan.com" style="text-decoration:none">EMAIL</a>
<a href="https://www.linkedin.com/in/austinmorlan" style="text-decoration:none">LINKEDIN</a>
<a href="https://twitter.com/vertexmachina" style="text-decoration:none">TWITTER</a>
<a href="https://austinmorlan.com/index.xml" style="text-decoration:none">RSS</a></div></div></center><noscript><img src=https://stats.austinmorlan.com/ingress/e0c3d2d3-31ba-48da-a01b-705c6884284a/pixel.gif></noscript><div class="content">Sep 30, 2019<br><br><h1 class="title">An Overview of NES Rendering</h1><hr><p>I’m in the midst of creating an NES emulator and struggled at first to understand how the rendering worked at
a high level. Nametable, attribute table, pattern table, background, sprites, palettes. The
<a href="http://wiki.nesdev.com/w/index.php/Nesdev_Wiki">Nesdev Wiki</a> has all of the info necessary but it isn’t
presented in a way that clicked with me. The details were abundant but the big picture view was missing.</p><p>Cross-referencing the wiki and <a href="https://www.qmtpro.com/~nes/nintendulator/">Nintendulator’s</a> debug views, I
put together a mental model of what’s going on. I’ll present that here.</p><p>It’s going to be high-level though, so I won’t be talking about addresses or cycle-by-cycle rendering. That’ll come
later.</p><div class="toc"><nav id="TableOfContents"><ul><li><a href="#overview">Overview</a></li><li><a href="#nametable">Nametable</a></li><li><a href="#pattern-table">Pattern Table</a></li><li><a href="#system-palette">System Palette</a></li><li><a href="#frame-palette">Frame Palette</a></li><li><a href="#background-colors">Background Colors</a></li><li><a href="#attribute-table">Attribute Table</a></li><li><a href="#sprites">Sprites</a></li><li><a href="#conclusion">Conclusion</a></li><li><a href="#discussion">Discussion</a></li></ul></nav></div><h2 id="overview">Overview</h2><hr><p>A frame is composed of a background and sprites. The background is fixed in place (ignoring scrolling) while sprites
can be in arbitrary positions around the screen and move independently of the background.</p><p>For the following explanation we’ll be using the original <a href="https://en.wikipedia.org/wiki/Donkey_Kong_(video_game)">Donkey Kong</a>,
an arcade game ported to the NES.</p><h2 id="nametable">Nametable</h2><hr><p>The background is made up of a grid of <strong>tiles</strong>, each tile being <strong>8x8 pixels</strong>. A frame is <strong>256x240 pixels</strong>
or <strong>32x30 tiles</strong>.</p><p>The nametable describes the layout of the frame’s background. The tiles start at <strong>(00,00)</strong> in the upper left
and increase downward to the right until the final tile in the bottom right at <strong>(1F,1D)</strong>.</p><p>The nametable is dynamic, meaning that it can (and often does) change frame-by-frame as the CPU sends data to the PPU
to fill the nametable. Each tile in the nametable contains a single byte in PPU memory.</p><p>Let’s take a look at the nametable in memory when the title screen for Donkey Kong is being displayed.</p><p>The numbers across the top are the tile’s X-index and the numbers down the left are the tile’s Y-index.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/nametable_01.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/nametable_01.png" alt="Title Screen Nametable 01" title="Title Screen Nametable 01"></a><p>It may just look like a bunch of numbers, but there are a lot of tiles with the value <strong>24</strong> so let’s
highlight all of the tiles that hold other values.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/nametable_02.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/nametable_02.png" alt="Title Screen Nametable 02" title="Title Screen Nametable 02"></a><p>There is an obvious pattern here: the words <strong>DONKEY KONG</strong> spelled out. Each of the tiles making up the words
contain the byte <strong>62</strong> which means nothing to us just yet.</p><p>Below are more numbers but their meaning isn’t immediately obvious.</p><p>What are those bytes? What are <strong>62</strong>, <strong>24</strong>, and all the rest? They’re indexes into the <strong>Pattern Table</strong>.</p><h2 id="pattern-table">Pattern Table</h2><hr><p>The pattern table contains the shape of each background tile and sprite. It’s static data residing in the ROM (or cartridge
on the actual NES) that the PPU can read from (but not write to). The byte in the nametable tile above is an index into
the pattern table. The contents in the pattern table describe what will be displayed.</p><p>Let’s use the tile at <strong>(09,10)</strong> as an example. It contains the value <strong>01</strong>. At index <strong>01</strong> in the pattern
table, there are sixteen bytes. Let’s separate them into the low bytes (the first eight) and the high bytes
(the second eight).</p><ul><li>0-7: <strong>18 38 18 18 18 18 7E 00</strong></li><li>8-F: <strong>00 00 00 00 00 00 00 00</strong></li></ul><p>That doesn’t mean anything in that form, so let’s lay them out on top of each other and display them in
binary form.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/pattern_table_01.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/pattern_table_01.png" alt="Pattern Table 01" title="Pattern Table 01"></a><p>Now we <strong>OR</strong> the first eight and the second eight together to get the final pattern. I’ll highlight every <strong>1</strong> to
better see them.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/pattern_table_02.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/pattern_table_02.png" alt="Pattern Table 02" title="Pattern Table 02"></a><p>There it is: the digit <strong>1</strong> drawn with binary.</p><p>Let’s do the six tiles to the right of that one, from <strong>(0B,10)</strong> to <strong>(10,10)</strong>, again laying out their
contents on top of each other in binary form. The second eight bytes are all zeros for the entire title screen,
so we’ll omit them. We’ll see later what happens when they aren’t zeros.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/pattern_table_player.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/pattern_table_player.png" alt="Pattern Table Player" title="Pattern Table Player"></a><p>Next we’ll do the next four tiles from <strong>(12,10)</strong> to <strong>(15,10)</strong>.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/pattern_table_game.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/pattern_table_game.png" alt="Pattern Table Game" title="Pattern Table Game"></a><p>Finally the final tile in that row at <strong>(17,10)</strong>.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/pattern_table_0A.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/pattern_table_0A.png" alt="Pattern Table 0A" title="Pattern Table 0A"></a><p>So all together that row of tiles spells out <strong>1 PLAYER GAME A</strong>.</p><p>Let’s look at the entire frame rendered in this way.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/monochrome_01.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/monochrome_01.png" alt="Title Screen Monochrome" title="Title Screen Monochrome"></a><p>The shapes are there but we’re missing color. Drawing in binary like this results in monochrome because a
pixel is either white or black.</p><p>You may think that it doesn’t look <em>that</em> bad monochrome. After all, the shapes are still there. But that’s
only true on this title screen. Let’s see what the actual game looks like this way.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/monochrome_02.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/monochrome_02.png" alt="Game Monochrome" title="Game Monochrome"></a><p>Yuck. That big blob at the top is supposed to be Donkey Kong but without colors he’s just a silhouette. The same is
true of the wooden barrels next to him and the oil drum at the bottom. We need color.</p><h2 id="system-palette">System Palette</h2><hr><p>The NES has a finite set of colors that a game can use to draw pixels. Let’s call that set of colors the <strong>system
palette</strong>.</p><p>The palette of the actual NES is rather complicated so many people have generated their own palettes to attempt
to reproduce the true colors. We’ll use
<a href="http://wiki.nesdev.com/w/index.php/File:Savtool-swatches.png">this one from the wiki</a>.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/system_palette.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/system_palette.png" alt="System Palette" title="System Palette"></a><p>Each color is given an index (<strong>00</strong> to <strong>3F</strong>) so that the game can refer to specific colors in the palette.</p><h2 id="frame-palette">Frame Palette</h2><hr><p>While the system palette contains a total of 64 colors, a single frame has its own palette that is a subset of the
system palette. Let’s call that set of colors the <strong>frame palette</strong></p><p>The system palette is static but the frame palette is dynamic: the CPU sends palette entries to the PPU so different
frames can use different sets of colors. But for a single frame only the colors in the frame palette can be displayed.</p><p>The frame palette is eight groups of colors of four colors each. Each group in the frame palette has an index
(<strong>0</strong> to <strong>7</strong>), and individual colors in that group also have indexes (<strong>0</strong> to <strong>3</strong>). <strong>Palette 0</strong> to
<strong>Palette 3</strong> are for the background and <strong>Palette 4</strong> to <strong>Palette 7</strong> are for the sprites.</p><p>For this particular frame of Donkey Kong, the frame palette looks like this:</p><a href="./An Overview of NES Rendering - Austin Morlan_files/frame_palette.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/frame_palette.png" alt="Frame Palette" title="Frame Palette"></a><h2 id="background-colors">Background Colors</h2><hr><p>If you recall, all of the tiles on the title screen had all zeros in the second group of eight bytes in the
pattern table, so the result of the <strong>OR</strong> operation with the first eight and the second eight was always either
a 1 or a 0. For an example of a background object where the second set of bytes are not zero, let’s look at the
oil drum at the bottom of the screen at <strong>(04,19)</strong>, <strong>(05,19)</strong>, <strong>(04,1A)</strong>, and <strong>(05,1A)</strong>. It’s composed
of four tiles.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/oil_drum_01.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/oil_drum_01.png" alt="Oil Drum 01" title="Oil Drum 01"></a><p>Again, we’ll take the first eight bytes in the pattern table of each of the four tiles and lay them out in
their proper tile locations in binary form.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/oil_drum_02.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/oil_drum_02.png" alt="Oil Drum 02" title="Oil Drum 02"></a><p>There we go, an oil drum. But this is still the monochrome version. Let’s look at the second set of eight
bytes laid out in the same manner.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/oil_drum_03.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/oil_drum_03.png" alt="Oil Drum 03" title="Oil Drum 03"></a><p>Now we <strong>OR</strong> both sets together to get a value for each pixel that is between <strong>00 (0)</strong> and <strong>11 (3)</strong>.</p><p>If we do that with the oil drum, with the upper bit coming from the second byte and the lower bit coming
from the first byte, we get the following.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/oil_drum_04.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/oil_drum_04.png" alt="Oil Drum 04" title="Oil Drum 04"></a><p>Now we have a value between <strong>00</strong> and <strong>11</strong> for each pixel, but what does that value mean? It’s an index
into the frame palette.</p><p>Look at the frame palette again.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/frame_palette.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/frame_palette.png" alt="Frame Palette" title="Frame Palette"></a><p>Knowing that the oil drum is using <strong>Palette 0</strong> (we’ll see how we know that later), then each of
the pixel’s colors are an index selecting one of four colors: <strong>0</strong> is black, <strong>1</strong> is magenta, <strong>2</strong> is teal, and <strong>3</strong> is
purple. We can color each pixel with those colors from the palette.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/oil_drum_05.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/oil_drum_05.png" alt="Oil Drum 05" title="Oil Drum 05"></a><p>Let’s remove the indexes.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/oil_drum_06.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/oil_drum_06.png" alt="Oil Drum 06" title="Oil Drum 06"></a><p>Looks great. But how did we know that the oil drum was using Palette 0? By using the <strong>Attribute Table</strong>.</p><h2 id="attribute-table">Attribute Table</h2><hr><p>The tiles on screen are further subdivided into <strong>blocks</strong>, each of which is <strong>4x4 tiles</strong>.</p><p>The oil drum we’re looking at is in block <strong>(1,6)</strong>. Here the thick lines indicate block boundaries.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_01.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_01.png" alt="Attribute Table 01" title="Attribute Table 01"></a><p>A block is subdivided into four regions of <strong>2x2</strong> tiles.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_02.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_02.png" alt="Attribute Table 02" title="Attribute Table 02"></a><p>In the attribute table, each block is represented by a single byte. The byte is made of four 2-bit values, one for each
2x2 quadrant of the block. Each value indicates the palette of each quadrant, so a block can have colors from four
different palettes</p><p><strong>Quad 0</strong> is controlled by <strong>Bits 0,1</strong>, <strong>Quad 1</strong> is controlled by
<strong>Bits 2,3</strong>, <strong>Quad 2</strong> is controlled by <strong>Bits 4,5</strong>, and <strong>Quad 3</strong> is controlled by <strong>Bits 6,7</strong>.</p><p>The value in the attribute table at the location for the oil drum is simply <strong>0</strong>, so all of the tiles in that
block use Palette 0.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_03.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_03.png" alt="Attribute Table 03" title="Attribute Table 03"></a><p>That’s pretty boring, so let’s do an example with multiple palettes in different blocks.</p><p>Donkey Kong is at the top of the screen. Part of him is in <strong>Block (1,1)</strong> and part of him is in <strong>Block (2,1)</strong>. He
shares a block with a steel girder and a ladder.</p><p><a href="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_04.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_04.png" alt="Attribute Table 04" title="Attribute Table 04"></a>
A</p><p>With the same procedure as before, we’ll look up each tile in the pattern table, lay them out, OR them together, and
get a value for each pixel between <strong>0</strong> and <strong>3</strong>.</p><p>The yellow lines are block boundaries, the white lines are quadrant boundaries, and the gray lines are tile boundaries.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_05.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_05.png" alt="Attribute Table 05" title="Attribute Table 05"></a><p>On the left we have <strong>Block (1,1)</strong> and on the right we have <strong>Block (2,1)</strong>.</p><p>The byte in the attribute table for <strong>Block (1,1)</strong> is <strong>AA</strong>.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_06.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_06.png" alt="Attribute Table 06" title="Attribute Table 06"></a><p>So that means each quadrant in the left block is using <strong>Palette 2</strong>: black, white, peach, and brown.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/frame_palette.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/frame_palette.png" alt="Frame Palette" title="Frame Palette"></a><p>We can color in the left block with that palette.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_07.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_07.png" alt="Attribute Table 07" title="Attribute Table 07"></a><p>The byte in the attribute table for <strong>Block (2,1)</strong> is <strong>22</strong>:</p><a href="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_08.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_08.png" alt="Attribute Table 08" title="Attribute Table 08"></a><p>So that means the upper left quadrant and the bottom left quadrant will use <strong>Palette 2</strong> while the upper right quadrant
and the bottom right quadrant will use <strong>Palette 0</strong> (refer to the diagram above that shows the quadrant order).</p><p>We can color in the right block with those two palettes.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_09.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_09.png" alt="Attribute Table 09" title="Attribute Table 09"></a><p>And then without the numbers.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_10.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/attribute_table_10.png" alt="Attribute Table 10" title="Attribute Table 10"></a><p>The rendering is now complete. The block on the right has colors from two different palettes while the block on the left
does not.</p><p>Here is the title screen with the background rendered.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/title_screen_final.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/title_screen_final.png" alt="Final Title Screen" title="Final Title Screen"></a><p>And the game screen with the background rendered.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/game_screen_final.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/game_screen_final.png" alt="Final Game Screen" title="Final Game Screen"></a><h2 id="sprites">Sprites</h2><hr><p>Sprites are rendered differently than the background. Sprites are dynamic: the CPU sends them to the PPU and the PPU
puts them into its memory. A single sprite is represented as four bytes: <strong>Y-Position</strong>, <strong>Tile Index</strong>, <strong>Attributes</strong>,
and <strong>X-Position</strong>.</p><p>The positions dictate where on screen the sprite is rendered, the tile index is an index into the sprite section of
the pattern table, and the attributes dictate the sprite’s appearance.</p><p>Let’s look at Mario. He’s composed of four sprites.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/sprite_01.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/sprite_01.png" alt="Sprite 01" title="Sprite 01"></a><p>We’ll ignore the positions and focus on the <strong>Tile ID</strong> and the <strong>Attributes</strong>. We’ll look up the tiles the same way
we did for the background and OR the two bytes together to get numbers from <strong>0</strong> to <strong>3</strong>.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/sprite_02.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/sprite_02.png" alt="Sprite 02" title="Sprite 02"></a><p>We now have palette indexes but we don’t know which palette to use. That’s what the attribute byte is for. <strong>Bit 1</strong> and
<strong>Bit 0</strong> are the index into the sprite section of the frame palette (<strong>Palette 4</strong> through <strong>Palette 7</strong>). For Mario,
the attributes byte is <strong>00</strong>, so <strong>Bit 1</strong> and <strong>Bit 0</strong> are 0. That means the palette is <strong>Palette 0</strong> of the sprite
palettes, or <strong>Palette 4</strong> of the entire frame palette.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/frame_palette.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/frame_palette.png" alt="Frame Palette" title="Frame Palette"></a><p>The colors are black, blue, peach, and red. We can color the pixels now.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/sprite_03.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/sprite_03.png" alt="Sprite 03" title="Sprite 03"></a><p>And without the numbers.</p><a href="./An Overview of NES Rendering - Austin Morlan_files/sprite_04.png" target="_blank"><img src="./An Overview of NES Rendering - Austin Morlan_files/sprite_04.png" alt="Sprite 04" title="Sprite 04"></a><h2 id="conclusion">Conclusion</h2><hr><p>That was a high-level overview of how all of the rendering bits fit together, which is great for creating a mental model
of the behavior, but it isn’t enough to do cycle-accurate PPU emulation. For that you need to understand PPU operation
at a scanline and cycle level, which will be a task for another day.</p><h2 id="discussion">Discussion</h2><hr><p><a href="https://old.reddit.com/r/austinmorlan/comments/v4clw6/an_overview_of_nes_rendering/">Discuss here</a></p><br><br><br><br></div></main></body></html>